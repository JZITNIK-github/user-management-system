<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Přihlášení</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <script>
        if (localStorage.getItem("token")) {
            window.location.replace("/dashboard")
        }
    </script>
</head>
<body>
    <div class="login">
        <h1>Přihlášení</h1>
        <input type="text" placeholder="Uživatelské jméno" class="username">
        <input type="password" placeholder="Heslo" class="password">
        <button class="submit">Přihlásit se</button>
    </div>
    <script>
        document.querySelector(".submit").addEventListener("click", () => {
            const username = document.querySelector(".username").value
            const password = document.querySelector(".password").value
            fetch("/api/login/",
            {
                headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
                },
                method: "POST",
                body: JSON.stringify({username: username, password: password})
            })
            .then(res=>res.json())
            .then(res=> {
                if (res["token"] == "none") {
                    alert("Uživatelské jméno nebo heslo je nesprávné")
                }
                else {
                    if (res["changePass"]) {
                        const password = prompt("Vytvořte si heslo pro váš účet: ")
                        if (password) {
                            fetch("/api/setPassword/",
                            {
                                headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                                },
                                method: "POST",
                                body: JSON.stringify({token: res.token, password: password})
                            })
                            .then(rs=>rs.json())
                            .then(rs=> {
                                if (!rs["response"] == "success") {
                                    alert("Heslo se nepovedlo nastavit! Budete požádání o nastavení nového hesla při příštím přihlášení.")
                                }
                                localStorage.setItem("token", res.token)
                                if (res.admin) {
                                    window.location.replace("/admin")
                                }
                                else {
                                    window.location.replace("/dashboard")
                                }
                            })
                        }
                        else {
                            alert("Heslo nebylo nastaveno! Budete požádání o nastavení nového hesla při příštím přihlášení.")
                        }
                    }
                    else {
                        localStorage.setItem("token", res.token)
                        if (res.admin) {
                            window.location.replace("/admin")
                        }
                        else {
                            window.location.replace("/dashboard")
                        }
                    }
                }
            })
            .catch(function(res){ console.log(res) })
        })
    </script>
</body>
</html>